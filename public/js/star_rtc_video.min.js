var sdpUtils=new SdpUtils;function ICEInfo(){this.iceUfrag="",this.icePwd="",this.iceOptions=""}function FingerprintInfo(){this.algorithm="",this.value=""}function CodecInfo(){this.payload=0,this.codecName="",this.codecInterval="",this.rtcpFB=[],this.fmtp=[]}function SSRCInfo(){this.ssrc=0,this.cname="",this.mslabel="",this.label=""}function MediaDesc(){this.type="",this.protocol="UDP/TLS/RTP/SAVPF",this.iceInfo=new ICEInfo,this.fingerprintInfo=new FingerprintInfo,this.setup="",this.mid="",this.msid="",this.extmap={},this.commAbility="sendrecv",this.rtcpMux=!0,this.rtcpResize=!1,this.codecInfoMap={},this.codecInfoArray=[],this.ssrcInfoMap={},this.ssrcInfoArray=[],this.ssrcGroup=[],this.candidate=[]}function SdpDesc(){this.version=0,this.username="-",this.sessionID=0,this.sessionVersion=0,this.sessionName="-",this.sessionStartTime=0,this.sessionEndTime=0,this.iceInfo=new ICEInfo,this.fingerprintInfo=new FingerprintInfo,this.group=[],this.wms=[],this.mediaDesc=[]}function SdpUtils(){SdpUtils.prototype.clone=function e(t){if(null==t||"object"!=typeof t)return t;if(t instanceof Date)return(i=new Date).setTime(t.getTime()),i;if(t instanceof Array){for(var i=[],s=t.length,n=0;n<s;++n)i[n]=e(t[n]);return i}if(t instanceof Object){i={};for(var a in t)t.hasOwnProperty(a)&&(i[a]=e(t[a]));return i}throw new Error("Unable to copy obj! Its type isn't supported.")},SdpUtils.prototype.parseSdp=function(e){var t=new SdpDesc,i=e.split("\r\n"),s=!1,n=null;for(var a in i){switch(i[a].charAt(0)){case"v":t.version=parseInt(i[a].substring(2));break;case"o":var r=i[a].substring(2).split(" ");t.username=r[0],t.sessionID=r[1],t.sessionVersion=r[2];break;case"s":t.sessionName=i[a].substring(2);break;case"t":r=i[a].substring(2).split(" ");t.sessionStartTime=parseInt(r[0]),t.sessionEndTime=parseInt(r[1]);break;case"m":null!=n&&(t.mediaDesc.push(n),n=null);r=i[a].substring(2).split(" ");(n=new MediaDesc).type=r[0],n.protocol=r[2];for(a=3;a<r.length;++a){(o=new CodecInfo).payload=parseInt(r[a]),n.codecInfoMap[o.payload]=o,n.codecInfoArray.push(o)}s=!0;break;case"a":if(s){if(-1!=i[a].indexOf("a=ice-ufrag:"))n.iceInfo.iceUfrag=i[a].substring(12);else if(-1!=i[a].indexOf("a=ice-pwd:"))n.iceInfo.icePwd=i[a].substring(10);else if(-1!=i[a].indexOf("a=ice-options:"))n.iceInfo.iceOptions=i[a].substring(14);else if(-1!=i[a].indexOf("a=fingerprint:")){r=i[a].substring(14).split(" ");n.fingerprintInfo.algorithm=r[0],n.fingerprintInfo.value=r[1]}else if(-1!=i[a].indexOf("a=setup:"))n.setup=i[a].substring(8);else if(-1!=i[a].indexOf("a=mid:"))n.mid=i[a].substring(6);else if(-1!=i[a].indexOf("a=extmap:")){r=i[a].substring(9).split(" ");n.extmap[r[0]]=r[1]}else if(-1!=i[a].indexOf("a=rtcp-mux"))n.rtcpMux=!0;else if(-1!=i[a].indexOf("a=rtcp-rsize"))n.rtcpResize=!0;else if(-1!=i[a].indexOf("a=sendrecv")||-1!=i[a].indexOf("a=sendonly")||-1!=i[a].indexOf("a=recvonly")||-1!=i[a].indexOf("a=inactive"))n.commAbility=i[a].substring(2);else if(-1!=i[a].indexOf("a=rtpmap:")){r=i[a].substring(9).split(" ");var o=n.codecInfoMap[r[0]],c=r[1].indexOf("/");r[1].split("/");o.codecName=r[1].substring(0,c),o.codecInterval=r[1].substring(c+1)}else if(-1!=i[a].indexOf("a=rtcp-fb:")){c=i[a].indexOf(" ");var d=i[a].substring(10,c);r=i[a].substring(c+1);(o=n.codecInfoMap[d]).rtcpFB.push(r)}else if(-1!=i[a].indexOf("a=fmtp:")){r=i[a].substring(7).split(" ");(o=n.codecInfoMap[r[0]]).fmtp.push(r[1])}else if(-1!=i[a].indexOf("a=msid:")){var l=i[a].substring(7);n.msid=l}else if(-1!=i[a].indexOf("a=ssrc:")){c=i[a].indexOf(" ");var f=i[a].substring(7,c),p=(r=i[a].substring(c+1).split(":"),n.ssrcInfoMap[f]);p||((p=new SSRCInfo).ssrc=f,n.ssrcInfoArray.push(p)),"cname"==r[0]?p.cname=r[1]:"msid"==r[0]?p.msid=r[1]:"mslabel"==r[0]?p.mslabel=r[1]:"label"==r[0]&&(p.label=r[1]),n.ssrcInfoMap[f]=p}else if(-1!=i[a].indexOf("a=ssrc-group:")){r=i[a].substring(13).split(" ");for(var a in r)n.ssrcGroup.push(r[a])}else if(-1!=i[a].indexOf("a=candidate:")){r=i[a].substring(12);n.candidate.push(r)}}else if(-1!=i[a].indexOf("group:BUNDLE")){var r=i[a].split(" ");for(a=1;a<r.length;++a)t.group.push(r[a])}else if(-1!=i[a].indexOf("msid-semantic:")){var r=i[a].split(" ");t.wms.push(r[r.length-1])}else if(-1!=i[a].indexOf("a=ice-ufrag:"))t.iceInfo.iceUfrag=i[a].substring(12);else if(-1!=i[a].indexOf("a=ice-pwd:"))t.iceInfo.icePwd=i[a].substring(10);else if(-1!=i[a].indexOf("a=ice-options:"))t.iceInfo.iceOptions=i[a].substring(14);else if(-1!=i[a].indexOf("a=fingerprint:")){var r=i[a].substring(14).split(" ");t.fingerprintInfo.algorithm=r[0],t.fingerprintInfo.value=r[1]}}}return null!=n&&(t.mediaDesc.push(n),n=null),t},SdpUtils.prototype.genIceInfoSdp=function(e){var t="";return""!=e.iceUfrag&&(t+="a=ice-ufrag:"+e.iceUfrag+"\r\n"),""!=e.icePwd&&(t+="a=ice-pwd:"+e.icePwd+"\r\n"),""!=e.iceOptions&&(t+="a=ice-options:"+e.iceOptions+"\r\n"),t},SdpUtils.prototype.genFingerprintSdp=function(e){var t="";return""!=e.algorithm&&(t+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"),t},SdpUtils.prototype.genCodecSdp=function(e){var t="";for(var i in t+="a=rtpmap:"+e.payload+" "+e.codecName+"/"+e.codecInterval+"\r\n",e.rtcpFB)t+="a=rtcp-fb:"+e.payload+" "+e.rtcpFB[i]+"\r\n";for(var i in e.fmtp)t+="a=fmtp:"+e.payload+" "+e.fmtp[i]+"\r\n";return t},SdpUtils.prototype.genSSRCSdp=function(e){var t="";return e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),e.msid&&(t+="a=ssrc:"+e.ssrc+" msid:"+e.msid+"\r\n"),e.mslabel&&(t+="a=ssrc:"+e.ssrc+" mslabel:"+e.mslabel+"\r\n"),e.label&&(t+="a=ssrc:"+e.ssrc+" label:"+e.label+"\r\n"),t},SdpUtils.prototype.genMediaSdp=function(e){var t="";t+="m="+e.type+" 9 "+e.protocol;var i="";for(var s in e.codecInfoArray){var n=e.codecInfoArray[s];t+=" "+n.payload,i+=this.genCodecSdp(n)}for(var s in t+="\r\n",t+="c=IN IP4 0.0.0.0\r\n",e.candidate)t+="a=candidate:"+e.candidate[s]+"\r\n";for(var a in 0<e.candidate.length&&(t+="a=end-of-candidates\r\n"),t+="a="+e.commAbility+"\r\n",t+="a=setup:"+e.setup+"\r\n",t+="a=mid:"+e.mid+"\r\n",e.msid&&(t+="a=msid:"+e.msid+"\r\n"),t+=this.genIceInfoSdp(e.iceInfo),t+=this.genFingerprintSdp(e.fingerprintInfo),1==e.rtcpMux&&(t+="a=rtcp-mux\r\n"),1==e.rtcpResize&&(t+="a=rtcp-rsize\r\n"),e.extmap)t+="a=extmap:"+a+" "+e.extmap[a]+"\r\n";for(var s in t+=i,e.ssrcGroup.length&&(t+="a=ssrc-group:FID "+e.ssrcGroup.join(" ")+"\r\n"),e.ssrcInfoArray)t+=this.genSSRCSdp(e.ssrcInfoArray[s]);return t},SdpUtils.prototype.genSdp=function(e){var t="";t+="v="+e.version+"\r\n",t+="o="+e.username+" "+e.sessionID+" "+e.sessionVersion+" IN IP4 127.0.0.1\r\n",t+="s="+e.sessionName+"\r\n",t+="t="+e.sessionStartTime+" "+e.sessionEndTime+"\r\n";var i="",s="";for(var n in e.mediaDesc)s+=" "+e.mediaDesc[n].mid,i+=this.genMediaSdp(e.mediaDesc[n]);return""!=s&&(t+="a=group:BUNDLE"+s+"\r\n"),0!=e.wms.length&&(t+="a=msid-semantic:WMS *\r\n"),t+=this.genIceInfoSdp(e.iceInfo),t+=this.genFingerprintSdp(e.fingerprintInfo),t+=i}}var StarWebRTC=function(){var n=RTCPeerConnection,a=(navigator.mediaDevices.getUserMedia,RTCIceCandidate,RTCSessionDescription),s=(navigator.mozGetUserMedia,{});function e(){this.events={}}function t(){this.localMediaStream=null,this.room="",this.fileData={},this.socket=null,this.me=null,this.peerConnections={},this.connections=[],this.numStreams=0,this.initializedStreams=0,this.dataChannels={},this.fileChannels={},this.receiveFiles={},this.bigStreamId="",this.smallStreamId="",this.audioStreamId="",this.bigSSRC="",this.smallSSRC="",this.audioSSRC="",this.answerSDP="",this.offerSDP=null,this.starPeerConnection=null,this.tempPC=null,this.callback=null,this.streamAllSetCallback=null,this.serverIp="0.0.0.0",this.serverPort=80,this.streamInfos=[]}function r(){this.videoId="",this.streamId="",this.bigVideoSSRC=0,this.smallVideoSSRC=0,this.audioSSRC=0,this.streamObj=null,this.switchFlag=!1}e.prototype.on=function(e,t){this.events[e]=this.events[e]||[],this.events[e].push(t)},e.prototype.emit=function(e,t){var i,s,n=this.events[e],a=Array.prototype.slice.call(arguments,1);if(n)for(i=0,s=n.length;i<s;i++)n[i].apply(null,a)},(t.prototype=new e).destroy=function(){this.emit("_remove_peer")},t.prototype.resetStreamInfos=function(e){this.streamInfos=[];for(var t=0;t<7;++t){var i=new r;i.bigVideoSSRC=2312312300+t,i.smallVideoSSRC=2312311300+t,i.audioSSRC=2312310300+t,i.streamId=this.createRandomString(o,36),i.cname=this.createRandomString(o,16),this.streamInfos.push(i)}},t.prototype.init=function(){this.resetStreamInfos();var c=this;this.on("_peers",function(e){c.connections=e.connections,c.me=e.you,c.emit("get_peers",c.connections)}),this.on("_remove_peer",function(e){c.closePeerConnection(c.starPeerConnection),null!=c.localMediaStream&&(c.localMediaStream.getTracks().forEach(function(e){e.stop()}),c.localMediaStream=null),c.bigStreamId="",c.smallStreamId="",c.audioStreamId="",c.bigSSRC="",c.smallSSRC="",c.audioSSRC="",c.answerSDP="",c.offerSDP=null,c.starPeerConnection=null,c.callback=null,c.serverIp="0.0.0.0",c.serverPort=80,c.resetStreamInfos()}),this.on("_offer",function(e){c.receiveOffer(e.socketId,e.sdp),c.emit("get_offer",e)}),this.on("_answer",function(e){var t=e.sessionDesc;t.type="answer",t.sdp=t.sdp.replace(/actpass/g,"active"),c.receiveAnswer(e.socketId,t),c.emit("get_answer",e)}),this.on("_webrtc_apply_ok",function(e,t,i,s){null==c.offerSDP&&(c.offerSDP=c.createDefaultSdpObj(i,s)),c.streamAllSetCallback=t;var n="candidate:504457478 1 udp 2122260223 "+c.serverIp+" "+c.serverPort+" typ host generation 0 ufrag Nud3 network-id 1",a=sdpUtils.clone(c.offerSDP);c.createAnswerFromOffer3(a,"Nud3","SKuOCnwS3ScdasO5hD2aheqb",e,c.streamInfos,[n]);var r=sdpUtils.genSdp(a),o={type:"offer"};o.sdp=r,c.starPeerConnection.setRemoteDescription(o).then(function(){c.starPeerConnection.createAnswer(function(e){var t=sdpUtils.parseSdp(e.sdp);c.filterSdpObj(t),c.replaceData(t);var i=sdpUtils.genSdp(t);e.sdp=i,c.starPeerConnection.setLocalDescription(e).then(function(){c.callback({type:"applyAnswer",status:"success"})},function(e){console.log(e),c.callback({type:"applyAnswer",status:"failed"})})},function(e){console.log(e),c.callback({type:"applyAnswer",status:"failed"})})},function(e){console.log(e),c.callback({type:"applyAnswer",status:"failed"})})}),this.on("ready",function(e,t){var i=t||!1;c.callback=e,c.createPeerConnections(),c.addStreams(i),c.sendOffers()})},t.prototype.createStream=function(a,t){var i=this;a.video||a.audio?navigator.mediaDevices.getUserMedia?(this.numStreams++,navigator.mediaDevices.enumerateDevices().then(function(e){for(var t=!1,i=!1,s=0;s!==e.length;++s){var n=e[s];"audioinput"===n.kind?t=!0:"audiooutput"===n.kind||("videoinput"===n.kind?i=!0:console.log("Some other kind of source/device: ",n))}return i||(a.video=!1),t||(a.audio=!1),navigator.mediaDevices.getUserMedia(a)}).then(function(e){i.localMediaStream=e,i.initializedStreams++,t("success",e)}).catch(function(e){t("failed",e)})):t("failed",new Error("WebRTC is not yet supported in this browser.")):t("success",null)},t.prototype.addStreams=function(i){if(null!=this.localMediaStream){var s=this;this.localMediaStream.getTracks().forEach(function(e){if(s.starPeerConnection.addTrack(e,s.localMediaStream),s.tempPC.addTrack(e,s.localMediaStream),"video"==e.kind){if(s.bigStreamId=e.id,!i){var t=e.clone();s.smallStreamId=t.id,t.applyConstraints({width:{ideal:120},height:{ideal:90},facingMode:{ideal:["user"]}}),s.starPeerConnection.addTrack(t,s.localMediaStream),s.tempPC.addTrack(t,s.localMediaStream)}}else"audio"==e.kind&&(s.audioStreamId=e.id)})}},t.prototype.attachStream=function(e,t){document.getElementById(t).srcObject=e},t.prototype.switchStream=function(t){var i=[];t.getVideoTracks().forEach(function(e){i.push(e),t.removeTrack(e)});for(var e=i.length-1;0<=e;e--)t.addTrack(i[e])},t.prototype.switchStreamInfo=function(e){e.switchFlag=!e.switchFlag,this.switchStream(e.streamObj)},t.prototype.resetStreamInfo=function(e){e.switchFlag&&this.switchStreamInfo(e)},t.prototype.switchStreams=function(){for(var e in this.streamInfos)this.switchStreamInfo(this.streamInfos[e])},t.prototype.getStreamByIndex=function(e){return this.streamInfos[e]},t.prototype.getStreamInfos=function(e){return this.streamInfos},t.prototype.onAddStream=function(e){var t=!0;for(var i in this.streamInfos){var s=this.streamInfos[i];s.streamId==e.id&&(s.streamObj=e),null==s.streamObj&&(t=!1)}t&&null!=this.streamAllSetCallback&&"connected"==this.starPeerConnection.iceConnectionState&&(this.streamAllSetCallback(),this.streamAllSetCallback=null)},t.prototype.setServerInfo=function(e){this.serverIp=e.serverIp,this.serverPort=e.serverPort};var o=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"],i=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"];return t.prototype.createRandomString=function(e,t){for(var i="",s=0;s<t;++s)i+=e[Math.floor(Math.random()*e.length)];return i},t.prototype.uuid=function(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},t.prototype.replaceData=function(e){for(var t in""==e.iceInfo.iceUfrag&&""!=this.sdpData.iceUfrag&&(e.iceInfo.iceUfrag=this.sdpData.iceUfrag,e.iceInfo.icePwd=this.sdpData.icePwd),e.mediaDesc){var i=e.mediaDesc[t];if(""!=this.sdpData.iceUfrag&&(i.iceInfo.iceUfrag=this.sdpData.iceUfrag,i.iceInfo.icePwd=this.sdpData.icePwd),"audio"==i.type){if(""!=this.audioStreamId&&-1!=i.msid.indexOf(this.audioStreamId)){var s=i.ssrcInfoArray[0];i.ssrcInfoArray=[],i.ssrcInfoMap={},s.ssrc=this.sdpData.audioSSRC,i.ssrcInfoArray.push(s),i.ssrcInfoMap[s.ssrc]=s}}else if("video"==i.type)if(""!=this.smallStreamId&&-1!=i.msid.indexOf(this.smallStreamId)){s=i.ssrcInfoArray[0];i.ssrcInfoArray=[],i.ssrcInfoMap={},s.ssrc=this.sdpData.smallVideoSSRC,i.ssrcInfoArray.push(s),i.ssrcInfoMap[s.ssrc]=s}else if(""!=this.bigStreamId&&-1!=i.msid.indexOf(this.bigStreamId)){s=i.ssrcInfoArray[0];i.ssrcInfoArray=[],i.ssrcInfoMap={},s.ssrc=this.sdpData.bigVideoSSRC,i.ssrcInfoArray.push(s),i.ssrcInfoMap[s.ssrc]=s}}},t.prototype.filterSdpObj=function(e){for(var t in e.mediaDesc){var i=e.mediaDesc[t];i.extmap={},i.ssrcGroup=[],i.codecInfoMap={};var s=[];for(var t in i.codecInfoArray){var n=i.codecInfoArray[t];"audio"==i.type?"opus"==n.codecName&&(s.push(n),i.codecInfoMap[n.payload]=n):"video"==i.type&&"H264"==n.codecName&&0==s.length&&(s.push(n),i.codecInfoMap[n.payload]=n)}i.codecInfoArray=s;var a={},r=[],o={};for(var t in i.ssrcInfoArray){var c=i.ssrcInfoArray[t];null==o[c.label]&&(o[c.label]=1,a[c.ssrc]=c,r.push(c))}i.ssrcInfoArray=r,i.ssrcInfoMap=a}},t.prototype.getSdpData=function(e,t){var i={audioSSRC:"",smallVideoSSRC:"",bigVideoSSRC:"",audioCodec:"0",videoCodec:"0",iceUfrag:"",icePwd:""};for(var s in i.iceUfrag=e.iceInfo.iceUfrag,i.icePwd=e.iceInfo.icePwd,e.mediaDesc){var n=e.mediaDesc[s];if(""==i.iceUfrag&&(i.iceUfrag=n.iceInfo.iceUfrag,i.icePwd=n.iceInfo.icePwd),"audio"==n.type){for(var a in n.ssrcInfoMap){var r=n.ssrcInfoMap[a];i.audioSSRC=r.ssrc}i.audioCodec=n.codecInfoArray[0].payload}else if("video"==n.type){for(var a in n.ssrcInfoMap){r=n.ssrcInfoMap[a];""!=t.bigStreamId&&(0==r.label.length?-1!=n.msid.indexOf(t.bigStreamId)&&(i.bigVideoSSRC=r.ssrc):-1!=r.label.indexOf(t.bigStreamId)&&(i.bigVideoSSRC=r.ssrc)),""!=t.smallStreamId&&(0==r.label.length?-1!=n.msid.indexOf(t.smallStreamId)&&(i.smallVideoSSRC=r.ssrc):-1!=r.label.indexOf(t.smallStreamId)&&(i.smallVideoSSRC=r.ssrc))}i.videoCodec=n.codecInfoArray[0].payload}}return i},t.prototype.createDefaultSdpObj=function(e,t){var i=new SdpDesc,s=new MediaDesc;s.type="video",s.rtcpResize=!0,s.fingerprintInfo.algorithm="sha-256",s.iceInfo.iceOptions="trickle";var n=new CodecInfo;n.payload=e,n.codecName="H264",n.codecInterval="90000",n.fmtp=["level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f"],n.rtcpFB=["goog-remb","transport-cc","ccm fir","nack","nack pli"],s.codecInfoArray=[n],s.codecInfoMap[n.payload]=n;var a=new MediaDesc;a.type="audio",a.fingerprintInfo.algorithm="sha-256",a.iceInfo.iceOptions="trickle";var r=new CodecInfo;return r.payload=t,r.codecName="opus",r.codecInterval="48000/2",r.fmtp=["minptime=10;useinbandfec=1"],r.rtcpFB=["transport-cc"],a.codecInfoArray=[r],a.codecInfoMap[r.payload]=r,i.mediaDesc=[a,s],i},t.prototype.createAnswerFromOffer3=function(e,t,i,s,n,a){""!=e.iceInfo.iceUfrag&&(e.iceInfo.iceUfrag=t),""!=e.iceInfo.icePwd&&(e.iceInfo.icePwd=i),""!=e.fingerprintInfo.algorithm&&(e.fingerprintInfo.value=s);var r=!1,o=!1,c=[];for(var d in e.mediaDesc){var l=e.mediaDesc[d];if(l.setup="actpass",l.iceInfo.iceUfrag=t,l.iceInfo.icePwd=i,""!=l.fingerprintInfo.algorithm&&(l.fingerprintInfo.value=s),l.candidate=a,l.ssrcInfoMap={},l.ssrcInfoArray=[],l.ssrcGroup=[],l.msid="","audio"!=l.type||r){if("video"==l.type&&!o)for(var f in o=!0,n){var p,m;if(0!=n[f].smallVideoSSRC)(p=sdpUtils.clone(l)).mid=l.type+"_s"+d+"_"+f,(m={}).ssrc=n[f].smallVideoSSRC,m.cname=n[f].cname,m.mslabel=n[f].streamId,m.label=this.uuid(),m.msid=m.mslabel+" "+m.label,p.ssrcInfoMap[m.ssrc]=m,p.ssrcInfoArray.push(m),p.msid=m.mslabel+" "+m.label,c.push(p);if(0!=n[f].bigVideoSSRC)(p=sdpUtils.clone(l)).mid=l.type+"_b"+d+"_"+f,(m={}).ssrc=n[f].bigVideoSSRC,m.cname=n[f].cname,m.mslabel=n[f].streamId,m.label=this.uuid(),m.msid=m.mslabel+" "+m.label,p.ssrcInfoMap[m.ssrc]=m,p.msid=m.mslabel+" "+m.label,p.ssrcInfoArray.push(m),c.push(p)}}else for(var f in r=!0,n){var u=sdpUtils.clone(l);u.mid=l.type+"_"+d+"_"+f;var h={};h.ssrc=n[f].audioSSRC,h.cname=n[f].cname,h.mslabel=n[f].streamId,h.label=this.uuid(),h.msid=h.mslabel+" "+h.label,u.ssrcInfoMap[h.ssrc]=h,u.ssrcInfoArray.push(h),u.msid=h.mslabel+" "+h.label,c.push(u)}}e.mediaDesc=c},t.prototype.sendOffers=function(){if(null==this.localMediaStream)return this.sdpData={audioSSRC:"",smallVideoSSRC:"",bigVideoSSRC:"",audioCodec:"0",videoCodec:"0",iceUfrag:this.createRandomString(i,4),icePwd:this.createRandomString(i,24)},void this.callback({type:"createOffer",status:"success",audioSSRC:this.sdpData.audioSSRC,smallVideoSSRC:this.sdpData.smallVideoSSRC,bigVideoSSRC:this.sdpData.bigVideoSSRC,videoCodec:this.sdpData.videoCodec,audioCodec:this.sdpData.audioCodec,iceUfrag:this.sdpData.iceUfrag,icePwd:this.sdpData.icePwd});var n,a=this;this.tempPC.createOffer((this.starPeerConnection,n=this.callback,function(e){var t=sdpUtils.parseSdp(e.sdp);a.filterSdpObj(t);var i=sdpUtils.genSdp(t);a.offerSDP=t,e.sdp=i;var s=a.getSdpData(t,{bigStreamId:a.bigStreamId,smallStreamId:a.smallStreamId});a.sdpData=s,a.tempPC.close(),delete a.tempPC,a.tempPC=null,n({type:"createOffer",status:"success",audioSSRC:s.audioSSRC,smallVideoSSRC:s.smallVideoSSRC,bigVideoSSRC:s.bigVideoSSRC,videoCodec:s.videoCodec,audioCodec:s.audioCodec,iceUfrag:s.iceUfrag,icePwd:s.icePwd})}),function(e){console.log(e),a.callback({type:"createOffer",status:"failed"})})},t.prototype.receiveOffer=function(e,t){this.starPeerConnection;this.sendAnswer(e,t)},t.prototype.sendAnswer=function(t,e){var i=this.starPeerConnection,s=this;i.setRemoteDescription(new a(e)),i.createAnswer(function(e){i.setLocalDescription(e),s.socket.send(JSON.stringify({eventName:"__answer",data:{socketId:t,sdp:e}}))},function(e){console.log(e)})},t.prototype.receiveAnswer=function(e,t){var i=this.starPeerConnection,s=this;i.setRemoteDescription(new a(t)).then(function(){s.callback({type:"applyAnswer",status:"success"})},function(e){s.callback({type:"applyAnswer",status:"failed"})})},t.prototype.createPeerConnections=function(){this.createPeerConnection("xuaisi")},t.prototype.createPeerConnection=function(e){var t=this,i=new n(s);return this.starPeerConnection=i,null!=this.localMediaStream&&(this.tempPC=new n(s)),i.onicecandidate=function(e){},i.oniceconnectionstatechange=function(e){"connected"===i.iceConnectionState&&null!=t.streamAllSetCallback&&(t.streamAllSetCallback(),t.streamAllSetCallback=null)},i.onopen=function(){t.emit("pc_opened",e,i)},i.onaddstream=function(e){t.onAddStream(e.stream)},i.ondatachannel=function(e){},i},t.prototype.closePeerConnection=function(e){e&&e.close()},t.prototype.broadcast=function(e){var t;for(t in this.dataChannels)this.sendMessage(e,t)},t.prototype.sendMessage=function(e,t){"open"===this.dataChannels[t].readyState.toLowerCase()&&this.dataChannels[t].send(JSON.stringify({type:"__msg",data:e}))},t.prototype.addDataChannels=function(){var e;for(e in this.peerConnections)this.createDataChannel(e)},t.prototype.createDataChannel=function(t,e){var i,s;i=this.peerConnections[t],t||this.emit("data_channel_create_error",t,new Error("attempt to create data channel without socket id")),i instanceof n||this.emit("data_channel_create_error",t,new Error("attempt to create data channel without peerConnection"));try{s=i.createDataChannel(e)}catch(e){this.emit("data_channel_create_error",t,e)}return this.addDataChannel(t,s)},t.prototype.addDataChannel=function(i,s){var n=this;return s.onopen=function(){n.emit("data_channel_opened",s,i)},s.onclose=function(e){delete n.dataChannels[i],n.emit("data_channel_closed",s,i)},s.onmessage=function(e){var t;"__file"===(t=JSON.parse(e.data)).type?n.parseFilePacket(t,i):n.emit("data_channel_message",s,i,t.data)},s.onerror=function(e){n.emit("data_channel_error",s,i,e)},this.dataChannels[i]=s},new t};